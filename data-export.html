<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Data Export</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007cba;
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background: #007cba; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .data-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .language-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        .german { background: #e3f2fd; color: #1976d2; }
        .japanese { background: #fce4ec; color: #c2185b; }
        .english { background: #f3e5f5; color: #7b1fa2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Survey Data Export</h1>
            <p>View and export all survey submissions stored locally</p>
        </div>

        <div class="stats" id="stats">
            <!-- Stats will be populated here -->
        </div>

        <div class="export-buttons">
            <button class="btn btn-primary" onclick="exportJSON()">üìÑ Export as JSON</button>
            <button class="btn btn-success" onclick="exportCSV()">üìä Export as CSV</button>
            <button class="btn btn-warning" onclick="clearData()">üóëÔ∏è Clear All Data</button>
            <button class="btn btn-danger" onclick="testGoogleSheets()">üîß Test Google Sheets</button>
        </div>

        <div id="dataDisplay">
            <!-- Data will be displayed here -->
        </div>
    </div>

    <script>
        let surveyData = [];

        function loadData() {
            const stored = localStorage.getItem('surveySubmissions');
            surveyData = stored ? JSON.parse(stored) : [];
            displayStats();
            displayData();
        }

        function displayStats() {
            const statsDiv = document.getElementById('stats');
            const total = surveyData.length;
            const german = surveyData.filter(d => d.language === 'german').length;
            const japanese = surveyData.filter(d => d.language === 'japanese').length;
            const english = surveyData.filter(d => d.language === 'english').length;

            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${total}</div>
                    <div>Total Submissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${german}</div>
                    <div>German Responses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${japanese}</div>
                    <div>Japanese Responses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${english}</div>
                    <div>English Responses</div>
                </div>
            `;
        }

        function displayData() {
            const displayDiv = document.getElementById('dataDisplay');
            
            if (surveyData.length === 0) {
                displayDiv.innerHTML = `
                    <div class="no-data">
                        <h3>üì≠ No Data Found</h3>
                        <p>No survey submissions have been stored locally yet.</p>
                        <p>Complete a survey to see data here.</p>
                    </div>
                `;
                return;
            }

            // Create table headers
            const headers = ['Timestamp', 'Language', 'Survey ID', 'Video URL'];
            
            // Add response headers based on first submission
            if (surveyData.length > 0) {
                const firstSubmission = surveyData[0];
                Object.keys(firstSubmission.responses).forEach(key => {
                    headers.push(`Q${key}`);
                });
            }

            let tableHTML = `
                <h3>üìã Survey Submissions (${surveyData.length} total)</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th>${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            surveyData.forEach((submission, index) => {
                const languageClass = submission.language || 'english';
                const languageBadge = `<span class="language-badge ${languageClass}">${submission.language || 'english'}</span>`;
                
                let row = `
                    <tr>
                        <td>${new Date(submission.timestamp).toLocaleString()}</td>
                        <td>${languageBadge}</td>
                        <td>${submission.surveyId}</td>
                        <td>${submission.videoUrl || 'N/A'}</td>
                `;

                // Add responses
                Object.keys(submission.responses).forEach(key => {
                    const response = submission.responses[key];
                    const displayValue = Array.isArray(response) ? response.join(', ') : (response || '');
                    row += `<td>${displayValue}</td>`;
                });

                row += '</tr>';
                tableHTML += row;
            });

            tableHTML += '</tbody></table>';
            displayDiv.innerHTML = tableHTML;
        }

        function exportJSON() {
            const dataStr = JSON.stringify(surveyData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `survey-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            if (surveyData.length === 0) {
                alert('No data to export!');
                return;
            }

            // Create headers
            const headers = ['Timestamp', 'Language', 'Survey ID', 'Survey Title', 'Video URL'];
            
            // Add response headers
            if (surveyData.length > 0) {
                Object.keys(surveyData[0].responses).forEach(key => {
                    headers.push(`Q${key}`);
                });
            }

            // Create CSV content
            let csvContent = headers.join(',') + '\n';

            surveyData.forEach(submission => {
                let row = [
                    new Date(submission.timestamp).toLocaleString(),
                    submission.language || 'english',
                    submission.surveyId,
                    submission.surveyTitle,
                    submission.videoUrl || 'N/A'
                ];

                // Add responses
                Object.keys(submission.responses).forEach(key => {
                    const response = submission.responses[key];
                    const value = Array.isArray(response) ? response.join('; ') : (response || '');
                    // Escape commas and quotes
                    const escapedValue = value.replace(/"/g, '""');
                    row.push(`"${escapedValue}"`);
                });

                csvContent += row.join(',') + '\n';
            });

            const dataBlob = new Blob([csvContent], {type: 'text/csv'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `survey-data-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all survey data? This cannot be undone.')) {
                localStorage.removeItem('surveySubmissions');
                surveyData = [];
                displayStats();
                displayData();
                alert('All data cleared!');
            }
        }

        async function testGoogleSheets() {
            const testData = {
                surveyId: 1,
                surveyTitle: "Data Export Test",
                language: "german",
                videoUrl: "https://youtu.be/test",
                timestamp: new Date().toISOString(),
                responses: {
                    1: "25‚Äì34 Jahre",
                    2: "M√§nnlich",
                    3: "Deutschland",
                    4: "Deutsch",
                    5: "Bachelor / Hochschulabschluss",
                    6: "Vollzeit angestellt (Festanstellung)",
                    7: "1.600 ‚Äì 2.800 ‚Ç¨",
                    8: "4",
                    9: ["3", "4", "3"],
                    10: "Umwelt und Nachhaltigkeit",
                    11: ["4", "3", "4", "3", "4"]
                }
            };

            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwVVAixDO1RXnLUZFO1cBhb8_fRVdU48dG_r39uFRDrZOSgqFktgODXjAQPjKwcaIDr/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Google Sheets Test Successful!\n\nMessage: ${result.message}\nRow Count: ${result.rowCount}`);
                } else {
                    alert(`‚ùå Google Sheets Test Failed!\n\nError: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Network Error!\n\nError: ${error.message}`);
            }
        }

        // Load data when page loads
        loadData();
    </script>
</body>
</html> 